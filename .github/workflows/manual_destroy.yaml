# checkov:skip=CKV_GHA_7:workflow_dispatch input is a safety control requiring explicit confirmation to destroy
name: Destroy Gatus

permissions:
  id-token: write
  contents: read

 # checkov:skip=CKV_GHA_7:Input is a confirmation gate for destroy workflow, not a build parameter
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm'
        required: true
        type: string
concurrency:
  group: terraform-ephemeral
  cancel-in-progress: false
jobs:
  terraform-destroy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'destroy'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: arn:aws:iam::313196411727:role/git-role
          aws-region: eu-west-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: infrastructure/ephemeral
        run: terraform init

      - name: Terraform Destroy
        working-directory: infrastructure/ephemeral
        run: terraform destroy --auto-approve -var="image_tag=${{ github.sha }}"
